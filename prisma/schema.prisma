generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// AUTH (Auth.js / NextAuth)
// ============================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  avatarUrl     String?
  title         String?
  department    String?
  bio                     String?
  notificationPreferences Json?
  isOnboarded             Boolean  @default(false)
  passwordHash            String?
  emailVerified DateTime?
  doNotDisturb            Boolean  @default(false)
  dndUntil                DateTime?
  locale                  String   @default("en")
  twoFactorEnabled        Boolean  @default(false)
  twoFactorSecret         String?
  backupCodes             Json?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts             Account[]
  sessions             Session[]
  workspaceMemberships WorkspaceMember[]
  teamMemberships      TeamMember[]
  assignedTasks        Task[]             @relation("TaskAssignee")
  createdTasks         Task[]             @relation("TaskCreator")
  comments             Comment[]
  attachments          Attachment[]
  notifications        Notification[]
  taskFollows          TaskFollower[]
  likes                Like[]
  statusUpdates        StatusUpdate[]
  reactions            Reaction[]
  visitHistory         VisitHistory[]
  userCapacity         UserCapacity[]
  annotations          Annotation[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================================
// WORKSPACE & TEAMS
// ============================================================

model Workspace {
  id          String   @id @default(cuid())
  name        String
  description String?
  logoUrl     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members                WorkspaceMember[]
  teams                  Team[]
  projects               Project[]
  customFieldDefinitions CustomFieldDefinition[]
  tags                   Tag[]
  portfolios             Portfolio[]
  goals                  Goal[]
  projectTemplates       ProjectTemplate[]
  tasks                  Task[]
  integrations           Integration[]
  savedReports           SavedReport[]
}

model WorkspaceMember {
  id          String        @id @default(cuid())
  workspaceId String
  userId      String
  role        WorkspaceRole @default(MEMBER)
  joinedAt    DateTime      @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
  GUEST
}

model Team {
  id          String   @id @default(cuid())
  name        String
  description String?
  workspaceId String
  createdAt   DateTime @default(now())

  workspace Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  members   TeamMember[]
  projects  Project[]
  goals     Goal[]

  @@index([workspaceId])
}

model TeamMember {
  id     String   @id @default(cuid())
  teamId String
  userId String
  role   TeamRole @default(MEMBER)

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
}

enum TeamRole {
  LEAD
  MEMBER
}

// ============================================================
// PROJECTS & SECTIONS
// ============================================================

model Project {
  id          String         @id @default(cuid())
  name        String
  description Json?
  color       String         @default("#4573D2")
  icon        String?
  defaultView ProjectView @default(LIST)
  privacy     ProjectPrivacy @default(PUBLIC)
  isArchived  Boolean        @default(false)
  startDate   DateTime?
  dueDate     DateTime?
  workspaceId String
  teamId      String?
  createdById String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  workspace      Workspace            @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  team           Team?                @relation(fields: [teamId], references: [id])
  sections       Section[]
  taskProjects   TaskProject[]
  customFields   ProjectCustomField[]
  members        ProjectMember[]
  statusUpdates  StatusUpdate[]
  rules          Rule[]
  forms          Form[]
  portfolioLinks PortfolioProject[]
  savedViews     SavedProjectView[]
  dashboardConfigs DashboardConfig[]

  @@index([workspaceId])
  @@index([teamId])
}

enum ProjectView {
  LIST
  BOARD
  TIMELINE
  CALENDAR
}

enum ProjectPrivacy {
  PUBLIC
  PRIVATE
  SPECIFIC_MEMBERS
}

model ProjectMember {
  id         String            @id @default(cuid())
  projectId  String
  userId     String
  permission ProjectPermission @default(EDITOR)

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
}

enum ProjectPermission {
  ADMIN
  EDITOR
  COMMENTER
  VIEWER
}

model Section {
  id        String @id @default(cuid())
  name      String
  projectId String
  position  Float

  project      Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  taskProjects TaskProject[]

  @@index([projectId, position])
}

// ============================================================
// TASKS
// ============================================================

model Task {
  id             String         @id @default(cuid())
  title          String
  description    Json?
  status         TaskStatus     @default(INCOMPLETE)
  completedAt    DateTime?
  assigneeId     String?
  parentTaskId   String?
  dueDate        DateTime?
  startDate      DateTime?
  isRecurring    Boolean        @default(false)
  recurrenceRule Json?
  isMilestone    Boolean        @default(false)
  isApproval     Boolean        @default(false)
  approvalStatus ApprovalStatus?
  estimatedHours Float?
  storyPoints    Float?
  workspaceId    String
  createdById    String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  parentTask Task?  @relation("TaskSubtasks", fields: [parentTaskId], references: [id], onDelete: Cascade)
  subtasks   Task[] @relation("TaskSubtasks")

  assignee  User?     @relation("TaskAssignee", fields: [assigneeId], references: [id])
  createdBy User      @relation("TaskCreator", fields: [createdById], references: [id])
  workspace Workspace @relation(fields: [workspaceId], references: [id])

  taskProjects      TaskProject[]
  dependsOn         TaskDependency[]      @relation("DependentTask")
  blocking          TaskDependency[]      @relation("BlockingTask")
  customFieldValues TaskCustomFieldValue[]
  tags              TaskTag[]
  followers         TaskFollower[]
  comments          Comment[]
  attachments       Attachment[]
  likes             Like[]
  activityLogs      ActivityLog[]
  reactions         Reaction[]
  approvalRequests  ApprovalRequest[]

  @@index([assigneeId, status])
  @@index([workspaceId, updatedAt])
  @@index([parentTaskId])
  @@index([dueDate])
}

enum TaskStatus {
  INCOMPLETE
  COMPLETE
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  CHANGES_REQUESTED
}

model TaskProject {
  id        String  @id @default(cuid())
  taskId    String
  projectId String
  sectionId String?
  position  Float

  task    Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  project Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  section Section? @relation(fields: [sectionId], references: [id])

  @@unique([taskId, projectId])
  @@index([projectId, sectionId, position])
}

model TaskDependency {
  id              String @id @default(cuid())
  taskId          String
  dependsOnTaskId String

  task      Task @relation("DependentTask", fields: [taskId], references: [id], onDelete: Cascade)
  dependsOn Task @relation("BlockingTask", fields: [dependsOnTaskId], references: [id], onDelete: Cascade)

  @@unique([taskId, dependsOnTaskId])
}

model TaskFollower {
  id     String @id @default(cuid())
  taskId String
  userId String

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
}

// ============================================================
// CUSTOM FIELDS
// ============================================================

model CustomFieldDefinition {
  id          String          @id @default(cuid())
  name        String
  type        CustomFieldType
  options     Json?
  workspaceId String
  createdById String
  createdAt   DateTime        @default(now())

  workspace     Workspace              @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  projectFields ProjectCustomField[]
  taskValues    TaskCustomFieldValue[]

  @@index([workspaceId])
}

enum CustomFieldType {
  TEXT
  NUMBER
  DATE
  SINGLE_SELECT
  MULTI_SELECT
  PEOPLE
  CURRENCY
  PERCENTAGE
  FORMULA
  ROLLUP
}

model ProjectCustomField {
  id            String @id @default(cuid())
  projectId     String
  customFieldId String
  position      Int    @default(0)

  project     Project               @relation(fields: [projectId], references: [id], onDelete: Cascade)
  customField CustomFieldDefinition @relation(fields: [customFieldId], references: [id], onDelete: Cascade)

  @@unique([projectId, customFieldId])
}

model TaskCustomFieldValue {
  id              String    @id @default(cuid())
  taskId          String
  customFieldId   String
  stringValue     String?
  numberValue     Float?
  dateValue       DateTime?
  selectedOptions Json?

  task        Task                  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  customField CustomFieldDefinition @relation(fields: [customFieldId], references: [id], onDelete: Cascade)

  @@unique([taskId, customFieldId])
}

// ============================================================
// COMMENTS, ATTACHMENTS, ACTIVITY
// ============================================================

model Comment {
  id           String   @id @default(cuid())
  taskId       String
  authorId     String
  body         Json
  isPinned     Boolean  @default(false)
  videoUrl     String?
  videoDuration Int?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  task      Task       @relation(fields: [taskId], references: [id], onDelete: Cascade)
  author    User       @relation(fields: [authorId], references: [id])
  likes     Like[]
  reactions Reaction[]

  @@index([taskId, createdAt])
}

model Attachment {
  id           String   @id @default(cuid())
  taskId       String
  uploadedById String
  fileName     String
  fileUrl      String
  fileSize     Int
  mimeType     String
  createdAt    DateTime @default(now())

  task        Task         @relation(fields: [taskId], references: [id], onDelete: Cascade)
  uploadedBy  User         @relation(fields: [uploadedById], references: [id])
  annotations Annotation[]

  @@index([taskId])
}

model Like {
  id        String   @id @default(cuid())
  userId    String
  taskId    String?
  commentId String?
  createdAt DateTime @default(now())

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  task    Task?    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  comment Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, taskId])
  @@unique([userId, commentId])
}

model ActivityLog {
  id        String   @id @default(cuid())
  taskId    String
  userId    String
  action    String
  field     String?
  oldValue  String?
  newValue  String?
  createdAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId, createdAt])
}

// ============================================================
// REACTIONS
// ============================================================

model Reaction {
  id        String   @id @default(cuid())
  userId    String
  emoji     String
  taskId    String?
  commentId String?
  createdAt DateTime @default(now())

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  task    Task?    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  comment Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, emoji, taskId])
  @@unique([userId, emoji, commentId])
  @@index([taskId])
  @@index([commentId])
}

// ============================================================
// TAGS
// ============================================================

model Tag {
  id          String @id @default(cuid())
  name        String
  color       String @default("#6D6E6F")
  workspaceId String

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  tasks     TaskTag[]

  @@unique([workspaceId, name])
}

model TaskTag {
  id     String @id @default(cuid())
  taskId String
  tagId  String

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([taskId, tagId])
}

// ============================================================
// NOTIFICATIONS
// ============================================================

model Notification {
  id           String           @id @default(cuid())
  userId       String
  type         NotificationType
  resourceType String
  resourceId   String
  actorId      String?
  message      String?
  isRead       Boolean          @default(false)
  isArchived   Boolean          @default(false)
  createdAt    DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead, createdAt])
  @@index([userId, isArchived, createdAt])
}

enum NotificationType {
  TASK_ASSIGNED
  TASK_COMPLETED
  COMMENT_ADDED
  MENTIONED
  STATUS_UPDATE
  APPROVAL_REQUEST
  APPROVAL_RESPONSE
  FOLLOWER_ADDED
  DUE_DATE_APPROACHING
  TASK_OVERDUE
}

// ============================================================
// STATUS UPDATES
// ============================================================

model StatusUpdate {
  id          String            @id @default(cuid())
  projectId   String?
  portfolioId String?
  authorId    String
  status      ProjectStatusType
  title       String
  body        Json
  createdAt   DateTime          @default(now())

  project Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  author  User     @relation(fields: [authorId], references: [id])

  @@index([projectId, createdAt])
}

enum ProjectStatusType {
  ON_TRACK
  AT_RISK
  OFF_TRACK
  ON_HOLD
  COMPLETE
}

// ============================================================
// PORTFOLIOS
// ============================================================

model Portfolio {
  id                String   @id @default(cuid())
  name              String
  description       String?
  workspaceId       String
  ownerId           String
  parentPortfolioId String?
  createdAt         DateTime @default(now())

  workspace       Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  parentPortfolio Portfolio?         @relation("NestedPortfolios", fields: [parentPortfolioId], references: [id])
  childPortfolios Portfolio[]        @relation("NestedPortfolios")
  projects        PortfolioProject[]

  @@index([workspaceId])
}

model PortfolioProject {
  id          String @id @default(cuid())
  portfolioId String
  projectId   String

  portfolio Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([portfolioId, projectId])
}

// ============================================================
// GOALS
// ============================================================

model Goal {
  id              String     @id @default(cuid())
  name            String
  description     String?
  workspaceId     String
  teamId          String?
  ownerId         String
  parentGoalId    String?
  status          GoalStatus @default(ON_TRACK)
  currentValue    Float      @default(0)
  targetValue     Float      @default(100)
  unit            String     @default("percent")
  timePeriodStart DateTime?
  timePeriodEnd   DateTime?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  workspace  Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  team       Team?     @relation(fields: [teamId], references: [id])
  parentGoal Goal?     @relation("GoalHierarchy", fields: [parentGoalId], references: [id])
  childGoals Goal[]    @relation("GoalHierarchy")

  @@index([workspaceId])
}

enum GoalStatus {
  ON_TRACK
  AT_RISK
  OFF_TRACK
  CLOSED
}

// ============================================================
// AUTOMATION
// ============================================================

model Rule {
  id          String   @id @default(cuid())
  name        String
  projectId   String
  trigger     Json
  conditions  Json?
  actions     Json
  isActive    Boolean  @default(true)
  createdById String
  createdAt   DateTime @default(now())

  project       Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)
  executionLogs RuleExecutionLog[]

  @@index([projectId, isActive])
}

model RuleExecutionLog {
  id        String   @id @default(cuid())
  ruleId    String
  taskId    String?
  status    String
  message   String?
  createdAt DateTime @default(now())

  rule Rule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([ruleId, createdAt])
}

model Form {
  id          String   @id @default(cuid())
  name        String
  description String?
  projectId   String
  fields      Json
  isPublished Boolean  @default(false)
  publicSlug  String?  @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([publicSlug])
}

model ProjectTemplate {
  id           String   @id @default(cuid())
  name         String
  description  String?
  templateData Json
  workspaceId  String
  createdById  String
  createdAt    DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
}

// ============================================================
// VISIT HISTORY
// ============================================================

model VisitHistory {
  id           String   @id @default(cuid())
  userId       String
  resourceType String
  resourceId   String
  resourceName String
  visitedAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, resourceType, resourceId])
  @@index([userId, visitedAt])
}

// ============================================================
// SAVED PROJECT VIEWS
// ============================================================

model SavedProjectView {
  id        String   @id @default(cuid())
  name      String
  projectId String
  createdById String
  config    Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

// ============================================================
// SAVED REPORTS & DASHBOARDS
// ============================================================

model SavedReport {
  id          String   @id @default(cuid())
  name        String
  workspaceId String
  createdById String
  config      Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
}

model DashboardConfig {
  id          String   @id @default(cuid())
  name        String
  projectId   String?
  createdById String
  layout      Json
  widgets     Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

// ============================================================
// APPROVAL WORKFLOWS
// ============================================================

model ApprovalRequest {
  id          String         @id @default(cuid())
  taskId      String
  requesterId String
  approverId  String
  status      ApprovalStatus @default(PENDING)
  comment     String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([approverId, status])
}

// ============================================================
// USER CAPACITY
// ============================================================

model UserCapacity {
  id              String @id @default(cuid())
  userId          String
  workspaceId     String
  weeklyHours     Float  @default(40)
  effectiveDate   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])
  @@index([workspaceId])
}

// ============================================================
// INTEGRATIONS
// ============================================================

model Integration {
  id          String   @id @default(cuid())
  workspaceId String
  type        String
  name        String
  config      Json?
  isActive    Boolean  @default(true)
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, type])
  @@index([workspaceId])
}

// ============================================================
// ANNOTATIONS (Image Proofing)
// ============================================================

model Annotation {
  id           String   @id @default(cuid())
  attachmentId String
  authorId     String
  x            Float
  y            Float
  width        Float?
  height       Float?
  body         String
  resolved     Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  attachment Attachment @relation(fields: [attachmentId], references: [id], onDelete: Cascade)
  author     User       @relation(fields: [authorId], references: [id])

  @@index([attachmentId])
}

// ============================================================
// AI CACHE
// ============================================================

model AiCache {
  id           String   @id @default(cuid())
  resourceType String
  resourceId   String
  result       Json
  model        String
  createdAt    DateTime @default(now())
  expiresAt    DateTime

  @@unique([resourceType, resourceId])
  @@index([expiresAt])
}
